<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Pro V10.5.01</title>
    
    <!-- ğŸ”’ è­¦è¡›æ©Ÿåˆ¶ï¼šæª¢æŸ¥æ˜¯å¦æœ‰ç™»å…¥ç´€éŒ„ -->
    <script>
        if (!localStorage.getItem('ecg_username')) {
            window.location.replace('login.html'); 
        }
    </script>

    <style>
        :root {
            /* --- DEFAULT DARK THEME --- */
            --bg-app: #0f172a;
            --bg-panel: #1e293b;
            --bg-card: #262626;
            --border-color: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --btn-hover: rgba(255,255,255,0.05);
            
            /* Fixed Monitor Colors (Always Dark) */
            --bg-monitor: #000000;
            
            /* Vital Colors (Neon) */
            --c-hr: #4ade80; --c-spo2: #38bdf8; --c-bp: #f472b6;
            --c-rr: #facc15; --c-temp: #ffffff;
            
            /* Status Colors */
            --st-norm: #4caf50; --st-warn: #ff9800; --st-crit: #f44336; --st-spec: #9c27b0;
            
            /* Meds */
            --drug-epi: #dca546; --drug-aden: #ef5350; --drug-amio: #42a5f5;
            --drug-atro: #66bb6a; --drug-mag: #ab47bc;
        }

        /* --- LIGHT THEME OVERRIDE --- */
        [data-theme="light"] {
            --bg-app: #f1f5f9;
            --bg-panel: #ffffff;
            --bg-card: #ffffff;
            --border-color: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --btn-hover: #f1f5f9;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            margin: 0; display: flex; height: 100vh;
            background-color: var(--bg-app); color: var(--text-main);
            overflow: hidden; transition: background-color 0.3s, color 0.3s;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 3px; }

        /* --- 1. Sidebar --- */
        aside {
            width: 240px; background: var(--bg-panel); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; flex-shrink: 0; transition: background 0.3s;
        }
        .brand {
            padding: 15px; font-size: 1.1rem; font-weight: 900; color: var(--c-hr);
            border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;
        }
        .ver-badge { font-size: 0.6rem; background: #333; color:#ccc; padding: 2px 6px; border-radius: 4px; }
        [data-theme="light"] .ver-badge { background: #e2e8f0; color:#475569; }

        .nav-scroll { flex: 1; overflow-y: auto; padding: 10px; }
        .nav-category {
            font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); 
            margin: 15px 0 5px 5px; font-weight: bold; letter-spacing: 1px; border-bottom: 1px solid var(--border-color);
        }
        .nav-btn {
            padding: 8px 10px; margin-bottom: 2px; border-radius: 4px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: space-between;
            font-size: 0.85rem; color: var(--text-muted); border-left: 3px solid transparent;
        }
        .nav-btn:hover { background: var(--btn-hover); color: var(--text-main); }
        .nav-btn.active { background: #2563eb; color: white; border-left-color: #60a5fa; font-weight: 600; }
        
        /* Dots */
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.norm { background: var(--st-norm); } .dot.warn { background: var(--st-warn); }
        .dot.crit { background: var(--st-crit); } .dot.spec { background: var(--st-spec); }

        /* Bottom Actions */
        .sidebar-footer { border-top: 1px solid var(--border-color); display: flex; }
        .footer-btn {
            flex: 1; padding: 12px; cursor: pointer; text-align: center; color: var(--text-muted);
            font-size: 1.2rem; transition: 0.2s;
        }
        .footer-btn:hover { background: var(--btn-hover); color: var(--text-main); }
        .footer-btn span { font-size: 0.7rem; display: block; font-family: sans-serif; font-weight: bold; margin-top: 2px;}

        /* --- 2. Main Content --- */
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        /* Monitor System */
        .top-container {
            flex: 0 0 420px; display: flex; background: var(--bg-monitor); border-bottom: 1px solid var(--border-color);
        }
        .monitor-screen {
            flex: 1; position: relative; background: var(--bg-monitor); overflow: hidden; border-right: 1px solid #333;
        }
        .ecg-grid {
            position: absolute; inset: 0; pointer-events: none; opacity: 0.2;
            background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .monitor-overlay {
            position: absolute; top: 10px; left: 15px; color: var(--c-hr); font-weight: bold; z-index: 5;
            text-shadow: 0 0 5px rgba(0,230,118,0.3); font-family: monospace;
        }
        .med-log {
            position: absolute; top: 10px; right: 15px; text-align: right; pointer-events: none;
            display: flex; flex-direction: column; gap: 5px; z-index: 10;
        }
        .log-item {
            background: rgba(20,20,20,0.8); color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 0.8rem; animation: fadeSlideIn 0.5s; border-left: 3px solid var(--c-hr);
        }
        @keyframes fadeSlideIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }

        /* Vitals */
        .vitals-panel {
            width: 150px; background: #080808; padding: 5px 10px;
            display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid #333;
        }
        .vital-row {
            display: flex; flex-direction: column; align-items: flex-end; padding: 4px 0;
            border-bottom: 1px solid #222; position: relative; flex: 1; justify-content: center;
        }
        .vital-label { font-size: 0.65rem; font-weight: bold; position: absolute; top: 2px; left: 0; opacity: 0.7; color: #ccc;}
        .vital-value { font-size: 1.8rem; font-weight: 700; line-height: 1; }
        .vital-unit { font-size: 0.6rem; opacity: 0.6; position: absolute; bottom: 2px; left: 0; color: #ccc;}
        .c-hr { color: var(--c-hr); } .c-bp { color: var(--c-bp); } .c-spo2 { color: var(--c-spo2); }
        .c-rr { color: var(--c-rr); } .c-temp { color: var(--c-temp); }

        .nibp-btn { 
            width: 100%; padding: 4px; background: #333; color: #ccc; border: none; 
            border-radius: 2px; cursor: pointer; font-size: 0.65rem; margin-top: 2px; 
        }
        .nibp-btn.active { background: var(--c-bp); color: white; }

        /* Controls */
        .control-panel { width: 240px; background: #151515; display: flex; flex-direction: column; }
        .defib-section {
            padding: 10px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 5px;
        }
        .energy-lcd {
            background: #000; color: #b2ff59; font-family: monospace; font-size: 1.2rem;
            text-align: center; padding: 2px; border: 1px solid #333; border-radius: 4px;
        }
        .defib-btns { display: flex; gap: 5px; }
        .btn-defib {
            flex: 1; border: none; border-radius: 4px; padding: 8px; font-weight: bold; cursor: pointer;
            font-size: 0.75rem; color: white; text-transform: uppercase;
        }
        .btn-charge { background: #ffb300; color: black; }
        .btn-shock { background: #333; color: #666; cursor: not-allowed; }
        .btn-shock.ready { background: #d50000; color: white; animation: pulse 0.5s infinite; }

        .meds-section { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .meds-title { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; text-align: center; margin-bottom: 5px; }
        .drug-btn {
            background: #2c2c2c; color: #ddd; border: none; padding: 8px; border-radius: 4px;
            text-align: left; cursor: pointer; font-size: 0.8rem; display: flex; justify-content: space-between;
            border-left: 4px solid #555; transition: 0.2s;
        }
        .drug-btn:hover { background: #333; transform: translateX(2px); }
        .drug-btn:active { transform: scale(0.98); }
        
        .d-aden { border-color: var(--drug-aden); } .d-epi { border-color: var(--drug-epi); }
        .d-amio { border-color: var(--drug-amio); } .d-atro { border-color: var(--drug-atro); }
        .d-mag { border-color: var(--drug-mag); } .drug-dose { font-size: 0.7rem; opacity: 0.6; }

        /* Bottom Section */
        .edu-container {
            flex: 1; padding: 20px; background: var(--bg-app); overflow: hidden;
            display: grid; grid-template-columns: 280px 1fr; gap: 20px; transition: background 0.3s;
        }
        
        .anatomy-box {
            background: var(--bg-card); border-radius: 8px; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .content-box {
            background: var(--bg-card); border-radius: 8px; overflow: hidden;
            display: flex; flex-direction: column; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .content-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .rhythm-title { font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin: 0; }
        .rhythm-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; color: white; font-weight: bold; }

        /* Tabs */
        .tabs { display: flex; background: rgba(0,0,0,0.1); border-bottom: 1px solid var(--border-color); }
        .tab-btn {
            padding: 10px 20px; color: var(--text-muted); cursor: pointer; font-size: 0.85rem; font-weight: bold; border-bottom: 2px solid transparent; flex: 1; text-align: center; background: transparent; border:none;
        }
        .tab-btn:hover { color: var(--text-main); background: rgba(0,0,0,0.05); }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; background: rgba(59,130,246,0.05); }
        
        .tab-content { padding: 20px; overflow-y: auto; color: var(--text-main); font-size: 0.9rem; line-height: 1.6; display: none; }
        .tab-content.active { display: block; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: var(--bg-card); width: 600px; max-width: 90%; border-radius: 8px; padding: 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid var(--border-color); color: var(--text-main);
            max-height: 80vh; display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-size: 1.1rem; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1);
        }
        .close-btn { cursor: pointer; color: var(--text-muted); font-size: 1.5rem; line-height: 1; }
        .close-btn:hover { color: var(--text-main); }
        
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .log-section { margin-bottom: 20px; }
        .log-title { color: #3b82f6; font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .log-entry { margin-bottom: 15px; }
        .ver-tag { background: #2563eb; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-right: 8px; }
        .date-tag { color: var(--text-muted); font-size: 0.8rem; }
        .log-ul { margin: 5px 0 0 0; padding-left: 20px; color: var(--text-main); font-size: 0.9rem; }
        .log-ul li { margin-bottom: 4px; }
        
        .ref-link { color: #38bdf8; text-decoration: none; display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .ref-link:hover { text-decoration: underline; }

        /* Animations & SVG */
        .flash-overlay { position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 100; }
        .flash-anim { animation: flash-screen 0.2s ease-out; }
        @keyframes flash-screen { 0%{opacity:1;} 100%{opacity:0;} }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.02);} 100%{transform:scale(1);} }
        
        .heart-svg { width: 100%; max-width: 200px; }
        .path-heart { fill: #334155; stroke: #475569; stroke-width: 2; transition: fill 0.3s; }
        [data-theme="light"] .path-heart { fill: #ffe4e6; stroke: #fb7185; } /* Light mode heart */

        .path-conduction { fill: none; stroke: #facc15; stroke-width: 3; opacity: 0.3; }
        .node { fill: #facc15; }
        .block-bar { fill: #f44336; display: none; }
        .mech-fail { fill: #1e293b !important; stroke: #334155 !important; }
        .reentry { animation: spin 0.4s linear infinite; transform-origin: 150px 140px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .flash { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; filter: drop-shadow(0 0 5px gold); } }

        h3 { color: #60a5fa; margin: 0 0 8px 0; font-size: 1rem; border-left: 3px solid #60a5fa; padding-left: 8px; }
        ul { margin: 0 0 15px 0; padding-left: 18px; } li { margin-bottom: 4px; }

        canvas { display: block; width: 100%; height: 100%; }

        @media (max-width: 1000px) {
            .top-container { flex-direction: column; height: auto; flex: none; }
            .monitor-screen { height: 220px; border-right: none; border-bottom: 1px solid #333; }
            .vitals-panel { width: 100%; flex-direction: row; justify-content: space-around; border-right: none; border-bottom: 1px solid #333; }
            .control-panel { width: 100%; flex-direction: row; }
            .meds-section { height: 150px; }
            .defib-section { width: 200px; border-right: 1px solid #333; }
            .edu-container { grid-template-columns: 1fr; }
            .anatomy-box { display: none; }
        }
    </style>
</head>
<body>

<aside>
    <div class="brand">
        <span>âš¡ä¸€å€‹çœ‹èµ·ä¾†å¾ˆé…·çš„å¿ƒé›»åœ–å­¸ç¿’ç¶²ç«™</span>
        <span class="ver-badge">V10.5</span>
    </div>

    <div class="nav-scroll">
        <!-- 1. Sinus -->
        <div class="nav-category">Sinusï¼ˆç«‡æ€§å¿ƒå¾‹ï¼‰</div>
        <div class="nav-btn active" onclick="loadCase('nsr')"><span>NSRï¼ˆæ­£å¸¸ç«‡æ€§å¿ƒå¾‹ï¼‰</span><div class="dot norm"></div></div>
        <div class="nav-btn" onclick="loadCase('sb')"><span>Sinus Bradycardiaï¼ˆç«‡æ€§ç·©è„ˆï¼‰</span><div class="dot norm"></div></div>

        <!-- 2. Atrial -->
        <div class="nav-category">Atrialï¼ˆæˆ¿æ€§å¿ƒå¾‹ï¼‰</div>
        <div class="nav-btn" onclick="loadCase('psvt')"><span>PSVTï¼ˆé™£ç™¼æ€§å®¤ä¸Šæ€§å¿ƒæéé€Ÿï¼‰</span><div class="dot warn"></div></div>
        <div class="nav-btn" onclick="loadCase('afib')"><span>AFib/AFï¼ˆå¿ƒæˆ¿é¡«å‹•ï¼‰</span><div class="dot warn"></div></div>
        <div class="nav-btn" onclick="loadCase('afl')"><span>A-Flutterï¼ˆå¿ƒæˆ¿æ’²å‹•ï¼‰</span><div class="dot warn"></div></div>

        <!-- 3. Ventricular -->
        <div class="nav-category">Ventricularï¼ˆå®¤æ€§å¿ƒå¾‹ï¼‰</div>
        <div class="nav-btn" onclick="loadCase('pvc')"><span>PVCï¼ˆå¿ƒå®¤æ—©æœŸæ”¶ç¸®ï¼‰</span><div class="dot warn"></div></div>
        <div class="nav-btn" onclick="loadCase('vt_pulse')"><span>VT/with Pulseï¼ˆå¿ƒå®¤é »è„ˆï¼‰</span><div class="dot crit"></div></div>
        <div class="nav-btn" onclick="loadCase('vt_pulseless')"><span>pVT/withour Pulseï¼ˆç„¡è„ˆæ€§å¿ƒå®¤é »è„ˆï¼‰</span><div class="dot crit"></div></div>
        <div class="nav-btn" onclick="loadCase('tdp')"><span>Torsade de pointes/TdPï¼ˆè·³è‘—èŠ­è•¾èˆçš„å¿ƒå¾‹ä¸æ•´ï¼‰</span><div class="dot crit"></div></div>
        <div class="nav-btn" onclick="loadCase('vf')"><span>VFï¼ˆå¿ƒå®¤é¡«å‹•ï¼‰</span><div class="dot crit"></div></div>

        <!-- 4. Blocks -->
        <div class="nav-category">AV Blocksï¼ˆå‚³å°é˜»æ»¯ï¼‰</div>
        <div class="nav-btn" onclick="loadCase('avb1')"><span>1st Degree AVBï¼ˆç¬¬ä¸€åº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼‰</span><div class="dot spec"></div></div>
        <div class="nav-btn" onclick="loadCase('avb2t1')"><span>2nd Degreeã€€AVB Type Iï¼ˆç¬¬äºŒåº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼Œç¬¬ä¸€å‹ï¼‰</span><div class="dot spec"></div></div>
        <div class="nav-btn" onclick="loadCase('avb2t2')"><span>2nd Degreeã€€AVB Type IIï¼ˆç¬¬äºŒåº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼Œç¬¬äºŒå‹ï¼‰</span><div class="dot spec"></div></div>
        <div class="nav-btn" onclick="loadCase('avb3')"><span>3rd Degreeã€€AVB (Complete)ï¼ˆç¬¬ä¸‰åº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼‰</span><div class="dot spec"></div></div>

        <!-- 5. Arrest -->
        <div class="nav-category">Arrest (æ€¥æ•‘)</div>
        <div class="nav-btn" onclick="loadCase('pea')"><span>PEAï¼ˆç„¡è„ˆæ€§é›»æ´»å‹•ï¼‰</span><div class="dot crit"></div></div>
        <div class="nav-btn" onclick="loadCase('asystole')"><span>Asystoleï¼ˆå¿ƒå¾‹åœæ­¢ï¼‰</span><div class="dot crit"></div></div>
    </div>

    <div class="sidebar-footer">
        <div class="footer-btn" onclick="toggleTheme()" title="Toggle Theme">
            ğŸŒ—<span>ä¸»é¡Œè®Šæ›´</span>
        </div>
        <div class="footer-btn" onclick="openModal()" title="About / Changelog">
            â„¹ï¸<span>é—œæ–¼é€™å€‹é…·æ±è¥¿</span>
        </div>
        <!-- æ–°å¢ç™»å‡ºæŒ‰éˆ• -->
        <div class="footer-btn" onclick="logout()" title="Sign Out" style="color:#ef4444;">
            ğŸšª<span>ç™»å‡º</span>
        </div>
    </div>
</aside>

<main>
    <!-- Monitor Deck -->
    <div class="top-container">
        <!-- ECG -->
        <div class="monitor-screen">
            <div class="ecg-grid"></div>
            <div class="flash-overlay" id="screen-flash"></div>
            
            <!-- Monitor Overlay with User Badge -->
            <div class="monitor-overlay">
                <div>LEAD II <span style="font-size:0.8em; opacity:0.7; margin-left:10px;">Stat Monitoring</span></div>
                <!-- é€™è£¡é¡¯ç¤ºé†«è­·äººå“¡åå­— -->
                <div id="user-staff-badge" style="font-size:0.85rem; color:var(--c-spo2); margin-top:4px; letter-spacing:1px; font-weight:normal; opacity:0.9;"></div>
            </div>

            <div class="med-log" id="med-log"></div>
            <canvas id="ecgCanvas"></canvas>
        </div>

        <!-- Vitals -->
        <div class="vitals-panel">
            <div class="vital-row c-hr"><div class="vital-label">HR</div><div class="vital-value" id="val-hr">72</div><div class="vital-unit">bpm</div></div>
            <div class="vital-row c-bp">
                <div class="vital-label">NIBP</div>
                <div style="display:flex; align-items:baseline;"><span class="vital-value" id="val-sys" style="font-size:1.6rem">120</span><span style="font-size:1.2rem; opacity:0.5; margin:0 2px;">/</span><span class="vital-value" id="val-dia" style="font-size:1.3rem">80</span></div>
                <div class="vital-unit">mmHg</div>
                <button class="nibp-btn" id="btn-nibp" onclick="toggleNIBP()">Start</button>
            </div>
            <div class="vital-row c-spo2"><div class="vital-label">SpO2</div><div class="vital-value" id="val-spo2">98</div><div class="vital-unit">%</div></div>
            <div class="vital-row c-rr"><div class="vital-label">RESP</div><div class="vital-value" id="val-rr">16</div><div class="vital-unit">rpm</div></div>
            <div class="vital-row c-temp"><div class="vital-label">TEMP</div><div class="vital-value" id="val-temp">37.0</div><div class="vital-unit">Â°C</div></div>
        </div>

        <!-- Controls -->
        <div class="control-panel">
            <div class="defib-section">
                <div class="energy-lcd"><span id="joule-val">200</span>J</div>
                <div class="defib-btns">
                    <button class="btn-defib btn-charge" id="btn-charge" onclick="charge()">Charge</button>
                    <button class="btn-defib btn-shock" id="btn-shock" onclick="shock()" disabled>Shock</button>
                </div>
            </div>
            <div class="meds-section">
                <div class="meds-title">CRASH CART</div>
                <button class="drug-btn d-aden" onclick="giveDrug('adenosine')"><span>Adenosine</span><span class="drug-dose">6mg</span></button>
                <button class="drug-btn d-epi" onclick="giveDrug('epi')"><span>Epinephrine</span><span class="drug-dose">1mg</span></button>
                <button class="drug-btn d-amio" onclick="giveDrug('amio')"><span>Amiodarone</span><span class="drug-dose">150mg</span></button>
                <button class="drug-btn d-atro" onclick="giveDrug('atropine')"><span>Atropine</span><span class="drug-dose">1mg</span></button>
                <button class="drug-btn d-mag" onclick="giveDrug('mag')"><span>Magnesium</span><span class="drug-dose">2g</span></button>
            </div>
        </div>
    </div>

    <!-- Education Deck -->
    <div class="edu-container">
        <div class="anatomy-box">
            <h4 style="color:var(--text-muted); margin-top:0;">Pathology View</h4>
            <svg class="heart-svg" viewBox="0 0 300 350">
                <path id="heart-muscle" class="path-heart" d="M150 330 C 50 300, 20 180, 20 120 C 20 60, 80 20, 150 90 C 220 20, 280 60, 280 120 C 280 180, 250 300, 150 330 Z" />
                <path class="path-conduction" d="M80 80 Q 115 110 150 140" />
                <path class="path-conduction" d="M150 140 L 150 190 L 100 260 M 150 190 L 200 260" />
                <circle id="node-sa" class="node" cx="80" cy="80" r="8" />
                <circle id="node-av" class="node" cx="150" cy="140" r="6" />
                <rect id="vis-block" class="block-bar" x="135" y="145" width="30" height="8" rx="2" />
                <circle id="vis-psvt" cx="150" cy="140" r="15" fill="none" stroke="#fdd835" stroke-width="3" stroke-dasharray="4,4" style="display:none;" />
                <g id="vis-tdp" style="display:none;">
                    <circle class="flash" cx="120" cy="220" r="6" fill="red" />
                    <circle class="flash" cx="180" cy="250" r="6" fill="red" style="animation-delay:0.2s"/>
                </g>
            </svg>
            <p id="anatomy-text" style="color:var(--text-muted); font-size:0.8rem; text-align:center; margin-top:10px;">Normal</p>
        </div>

        <div class="content-box">
            <div class="content-header">
                <div class="rhythm-title" id="txt-title">NSR æ­£å¸¸ç«‡æ€§å¿ƒå¾‹</div>
                <span class="rhythm-tag" id="txt-tag" style="background:#4caf50;">Normal</span>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="setTab('overview')">å¤§ç¶±</button>
                <button class="tab-btn" onclick="setTab('patho')">ç—…ç†</button>
                <button class="tab-btn" onclick="setTab('rx')">æ²»ç™‚</button>
            </div>
            <div id="tab-overview" class="tab-content active">
                <h3>ğŸ“Š E.K.G. Criteriaï¼ˆå¿ƒé›»åœ–ç‰¹å¾µï¼‰</h3>
                <ul id="list-criteria"></ul>
                <div id="alert-box" style="padding:10px; background:rgba(239,68,68,0.1); border:1px solid #ef4444; color:#fca5a5; border-radius:4px; display:none;"></div>
            </div>
            <div id="tab-patho" class="tab-content">
                <h3>ğŸ§¬ ç—…ç†æ©Ÿè½‰</h3>
                <p id="txt-patho"></p>
                <h3>ğŸ” è‡´ç—…åŸå› </h3>
                <ul id="list-causes"></ul>
            </div>
            <div id="tab-rx" class="tab-content">
                <h3>ğŸ’Š ACLS æ²»ç™‚æŒ‡å¼•</h3>
                <ul id="list-rx"></ul>
                <h3>â¤ï¸ è­·ç†æªæ–½</h3>
                <ul id="list-nurse"></ul>
            </div>
        </div>
    </div>
</main>

<!-- Modal Info -->
<div id="info-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>System Information</span>
            <span class="close-btn" onclick="closeModal()">âœ•</span>
        </div>
        <div class="modal-body">
            <div class="log-section">
                <div class="log-title">ğŸ“‹ æ›´æ–°æ—¥èªŒ</div>
                <div class="log-entry">
                    <div><span class="ver-tag">v10.5</span> <span class="date-tag">2025.11.20</span></div>
                    <ul class="log-ul">
                        <li><strong>New Feature:</strong> æ–°å¢æ—¥/å¤œé–“æ¨¡å¼åˆ‡æ›åŠŸèƒ½ (Dark/Light Theme)ã€‚</li>
                        <li><strong>Content:</strong> æ–°å¢è©³ç´°ç—…ç†æ©Ÿè½‰èˆ‡å¸¸è¦‹æˆå› é ç±¤ã€‚</li>
                        <li><strong>UI:</strong> å´é‚Šæ¬„ä¾ç…§è‡¨åºŠåˆ†é¡é‡æ§‹ (Sinus, Atrial, Ventricular...)ã€‚</li>
                        <li><strong>System:</strong> æ•´åˆè³‡è¨Šä¸­å¿ƒ (æ›´æ–°æ—¥èªŒã€è£½ä½œäººå“¡ã€è³‡æ–™ä¾†æº)ã€‚</li>
                    </ul>
                </div>
                <div class="log-entry">
                    <div><span class="ver-tag">v10.3</span></div>
                    <ul class="log-ul">
                        <li>æ¢å¾©å®Œæ•´ç”Ÿå‘½å¾µè±¡ (RR, Temp) é¡¯ç¤ºèˆ‡æ•¸å€¼é€£å‹•ã€‚</li>
                    </ul>
                </div>
            </div>
            
            <div class="log-section">
                <div class="log-title">ğŸ‘¥å‰µä½œè€…</div>
                <p style="font-size:0.9rem; color:var(--text-main);">
                    <strong>æ¦‚å¿µèˆ‡è¨­è¨ˆï¼š</strong>å“²ç‘‹<br>
                    <strong>é–‹ç™¼å°åŠ©æ‰‹ï¼š</strong>Google AI Studio (Gemini 2.0)<br>
                    <strong>ç›®å‰ç‰ˆæœ¬ï¼š</strong>10.5 Build 202511
                </p>
            </div>

            <div class="log-section" style="margin-bottom:0;">
                <div class="log-title">ğŸ“šåƒè€ƒè³‡æ–™èˆ‡ä¾†æº</div>
                <a href="https://cpr.heart.org/" target="_blank" class="ref-link">AHA ACLS Guidelines 2020-2025</a>
                <a href="https://litfl.com/ecg-library/" target="_blank" class="ref-link">Life in the Fast Lane (LITFL) - ECG Library</a>
                <a href="https://www.ncbi.nlm.nih.gov/books/NBK470297/" target="_blank" class="ref-link">StatPearls - Torsades de Pointes</a>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Data (å®Œæ•´åŸç‰ˆè³‡æ–™) ---
    const DB = {
        'nsr': { t:"Norml Sinus Rhythm, NSRï¼ˆæ­£å¸¸ç«‡æ€§å¿ƒå¾‹ï¼‰", b:"Normal", c:"#4caf50", shock:false, hr:72, sys:120, dia:80, spo2:98, rr:16, temp:37.0, cri:["å¿ƒè·³é€Ÿç‡ï¼š60-100 bpm", "ç¯€å¾‹è¦å‰‡", "Pæ³¢æ¸…æ¥šï¼ŒPR 0.12-0.20s"], patho:"é›»è¨Šè™Ÿç”±ç«‡æˆ¿çµï¼ˆSA Nodeï¼‰é–‹å§‹ï¼Œç¶“æˆ¿å®¤çµï¼ˆAV Nodeï¼‰å‚³è‡³å¿ƒå®¤ï¼Œè·¯å¾‘å®Œæ•´ã€‚", cause:["å¥åº·å¿ƒè‡Ÿ", "ä¼‘æ¯ç‹€æ…‹"], rx:["ç„¡éœ€ç‰¹æ®Šæ²»ç™‚"], n:["çºŒè§€"], vis:'nsr' },
        'sb': { t:"Sinus Bradycardia, Bardyï¼ˆç«‡æ€§ç·©è„ˆï¼‰", b:"Brady", c:"#4caf50", shock:false, hr:45, sys:95, dia:60, spo2:96, rr:14, temp:36.8, cri:["Rate < 60 bpm", "P-QRS-T æ³¢å½¢æ­£å¸¸"], patho:"ç«‡æˆ¿çµç™¼ç«é »ç‡é™ä½ï¼Œä½†å‚³å°è·¯å¾‘æ­£å¸¸ã€‚", cause:["ç¡çœ /é‹å‹•å“¡", "è¿·èµ°ç¥ç¶“äº¢é€²", "è—¥ç‰© (Beta-blocker)"], rx:["è§€å¯Ÿ", "æœ‰ç—‡ç‹€çµ¦ Atropine"], n:["ç›£æ¸¬è¡€å£“èˆ‡æ„è­˜"], vis:'nsr' },
        'psvt': { t:"Paroxysmal Supraventricular Tachycardia, PSVTï¼ˆé™£ç™¼æ€§å®¤ä¸Šæ€§å¿ƒæéé€Ÿï¼‰", b:"Tachy", c:"#ff9800", shock:false, hr:188, sys:90, dia:60, spo2:94, rr:24, temp:37.2, cri:["Rate 150-250 bpm", "QRS çª„æ³¢", "Pæ³¢éš±è—"], patho:"æˆ¿å®¤çµæŠ˜è¿” (AVNRT)ã€‚å­˜åœ¨é›™å¾‘è·¯å½¢æˆçŸ­è·¯ã€‚", cause:["å£“åŠ›/ç„¦æ…®/å’–å•¡å› ", "WPW ç—‡å€™ç¾¤"], rx:["Vagal Maneuver", "Adenosine 6mg IVP"], n:["æ¥ä¸‰é€šç®¡+æŠ¬æ‰‹", "å‚™å¦¥æ€¥æ•‘è»Š"], vis:'psvt' },
        'afib': { t:"Atrial Fibrillation, AFib/AFï¼ˆå¿ƒæˆ¿é¡«å‹•ï¼‰", b:"Irregular", c:"#ff9800", shock:false, hr:130, sys:110, dia:70, spo2:95, rr:20, temp:36.9, cri:["çµ•å°ä¸è¦å‰‡", "ç„¡ P æ³¢ (f waves)"], patho:"å¿ƒæˆ¿å¤šè™•å¾®æŠ˜è¿”äº‚æ”¾é›»ï¼Œå¤±å»æ”¶ç¸®åŠŸèƒ½ã€‚", cause:["é«˜è¡€å£“", "å¿ƒè¡°ç«­", "è€åŒ–"], rx:["å¿ƒç‡æ§åˆ¶", "Anticoagulation"], n:["ç›£æ¸¬è„ˆæ", "è©•ä¼°ä¸­é¢¨"], vis:'afib' },
        'afl': { t:"A-Flutterï¼ˆå¿ƒæˆ¿æ’²å‹•ï¼‰", b:"Tachy", c:"#ff9800", shock:false, hr:150, sys:110, dia:70, spo2:95, rr:18, temp:37.0, cri:["é‹¸é½’ç‹€æ’²å‹•æ³¢", "F waves", "è¦å‰‡ (2:1)"], patho:"å¿ƒæˆ¿å–®ä¸€å·¨å¤§æŠ˜è¿”è¿´è·¯ã€‚", cause:["COPD", "å¿ƒè‡Ÿç—…"], rx:["å¿ƒç‡æ§åˆ¶", "æ¶ˆèè¡“"], n:["ç›£æ¸¬"], vis:'psvt' },
        'pvc': { t:"Premature Ventricular Contraction, PVCï¼ˆå¿ƒå®¤æ—©æœŸæ”¶ç¸®ï¼‰", b:"Ectopic", c:"#ff9800", shock:false, hr:"Irreg", sys:115, dia:75, spo2:97, rr:16, temp:37.0, cri:["å¯¬å¤§è®Šå½¢ QRS", "ææ—©å‡ºç¾", "ä»£å„Ÿæ€§æš«åœ"], patho:"å¿ƒå®¤ç•°ä½é»ææ—©æ”¾é›»ã€‚", cause:["ä½è¡€é‰€/é‚", "ç¼ºæ°§", "å’–å•¡å› "], rx:["è§€å¯Ÿ", "æ²»ç™‚ç—…å› "], n:["ç›£æ¸¬é »ç‡"], vis:'nsr' },
        'vt_pulse': { t:"Ventricular Tachycardia, VT/with Pulseï¼ˆå¿ƒå®¤é »è„ˆï¼‰", b:"Emergency", c:"#f44336", shock:false, hr:170, sys:90, dia:50, spo2:92, rr:26, temp:37.0, cri:["å¯¬å¤§ QRS", "è¦å‰‡å¿«é€Ÿ", "å–®å‹æ€§"], patho:"å¿ƒå®¤æŠ˜è¿”æˆ–ç•°ä½é»ä¸»å°ã€‚å……è¡€ä¸è¶³ã€‚", cause:["å¿ƒè‚Œæ¢—å¡", "é›»è§£è³ªç•°å¸¸"], rx:["Amiodarone", "åŒæ­¥æ•´æµ"], n:["æ‘¸è„ˆæï¼", "12å°ç¨‹"], vis:'vt' },
        'vt_pulseless': { t:"Ventricular Tachycardia, pVT/withour Pulseï¼ˆç„¡è„ˆæ€§å¿ƒå®¤é »è„ˆï¼‰", b:"Arrest", c:"#f44336", shock:true, hr:180, sys:"---", dia:"---", spo2:"?", rr:0, temp:36.5, cri:["å¯¬å¤§ QRS", "ç„¡è„ˆæ"], patho:"åŒ VT ä½†å¿ƒè¼¸å‡ºé‡ç‚ºé›¶ã€‚", cause:["åŒ VT"], rx:["Defib 200J", "CPR"], n:["Code Blue"], vis:'vt' },
        'vf': { t:"Ventricular Fibrillation, VFï¼ˆå¿ƒå®¤é¡«å‹•ï¼‰", b:"Arrest", c:"#f44336", shock:true, hr:"---", sys:"---", dia:"---", spo2:"?", rr:0, temp:36.5, cri:["æ³¢å½¢æ··äº‚", "ç„¡ QRS", "ç„¡è„ˆæ"], patho:"å¿ƒå®¤è‚Œçº–ç¶­æ··äº‚é¡«å‹•ï¼Œç„¡æ©Ÿæ¢°æ”¶ç¸®ã€‚", cause:["æ€¥æ€§ MI", "R-on-T"], rx:["ç«‹å³é›»æ“Š", "CPR"], n:["Clear for Shock"], vis:'vf' },
        'tdp': { t:"Torsades de Pointes, TdPï¼ˆè·³è‘—èŠ­è•¾èˆçš„å¿ƒå¾‹ä¸æ•´ï¼‰", b:"Arrest", c:"#f44336", shock:true, hr:220, sys:"---", dia:"---", spo2:"?", rr:0, temp:36.5, cri:["å¤šå‹æ€§ VT", "æ³¢å½¢æ‰­è½‰"], patho:"QT å»¶é•·å°è‡´ R-on-T ç¾è±¡ã€‚", cause:["ä½è¡€é‚", "è—¥ç‰©å‰¯ä½œç”¨"], rx:["Magnesium", "Defib"], n:["å‚™é‚é›¢å­"], vis:'tdp' },
        'avb1': { t:"1st Degree AV-Block, 1Â° AVBï¼ˆç¬¬ä¸€åº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼‰", b:"Block", c:"#9c27b0", shock:false, hr:70, sys:118, dia:76, spo2:98, rr:16, temp:37.0, cri:["PR Interval > 0.20s", "Rhythm è¦å‰‡"], patho:"æˆ¿å®¤çµå‚³å°å»¶é²ã€‚", cause:["è—¥ç‰©", "è¿·èµ°ç¥ç¶“"], rx:["è§€å¯Ÿ"], n:["ç›£æ¸¬"], vis:'block-mild' },
        'avb2t1': { t:"2nd Degree AV-Block Type I, 2Â°-1 AVBï¼ˆç¬¬äºŒåº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼Œç¬¬ä¸€å‹ï¼‰", b:"Block", c:"#9c27b0", shock:false, hr:60, sys:110, dia:70, spo2:97, rr:16, temp:37.0, cri:["PR æ¼¸é•·å¾Œæ¼è·³ (Wenckebach)"], patho:"æˆ¿å®¤çµç–²å‹ç¾è±¡ã€‚", cause:["ä¸‹å£ MI", "ä¸­æ¯’"], rx:["è§€å¯Ÿ"], n:["å‚™è—¥"], vis:'block-mod' },
        'avb2t2': { t:"2nd Degree Type II, 2Â°-2 AVï¼ˆç¬¬äºŒåº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼Œç¬¬äºŒå‹ï¼‰B", b:"Danger", c:"#9c27b0", shock:false, hr:50, sys:100, dia:60, spo2:95, rr:18, temp:36.8, cri:["PR å›ºå®š", "çªç„¶æ¼è·³ QRS"], patho:"å¸Œæ°æŸä¸‹æ–¹ç—…è®Šã€‚", cause:["å‰å£ MI"], rx:["TCP Standby", "PPM"], n:["è²¼ Pacing Pads"], vis:'block-mod' },
        'avb3': { t:"3rd Degree AVB, 3Â° AVBï¼ˆç¬¬ä¸‰åº¦æˆ¿å®¤å‚³å°é˜»æ»¯ï¼‰", b:"Critical", c:"#9c27b0", shock:false, hr:35, sys:80, dia:40, spo2:90, rr:12, temp:36.5, cri:["æˆ¿å®¤åˆ†é›¢", "Pèˆ‡QRSäº’ä¸ç›¸å¹²"], patho:"æˆ¿å®¤å‚³å°å®Œå…¨ä¸­æ–·ã€‚", cause:["MI", "çº–ç¶­åŒ–"], rx:["TCP", "PPM"], n:["é˜²è·Œå€’", "TCP"], vis:'block-comp' },
        'pea': { t:"Pulseless Electrical Activity, PEAï¼ˆç„¡è„ˆæ€§é›»æ´»å‹•ï¼‰", b:"Arrest", c:"#f44336", shock:false, hr:70, sys:"---", dia:"---", spo2:"?", rr:0, temp:36.5, cri:["ECG æœ‰æ³¢å½¢", "<strong>ä½†ç„¡è„ˆæ</strong>"], patho:"é›»æ°£æ­£å¸¸ä½†æ©Ÿæ¢°è¡°ç«­ã€‚", cause:["5H5T"], rx:["CPR", "Epi"], n:["æ‘¸è„ˆæ"], vis:'pea' },
        'asystole': { t:"Asystoleï¼ˆå¿ƒå¾‹åœæ­¢ï¼‰", b:"Arrest", c:"#f44336", shock:false, hr:0, sys:"---", dia:"---", spo2:"?", rr:0, temp:36.0, cri:["ä¸€ç›´ç·š"], patho:"é›»æ°£æ´»å‹•åœæ­¢ã€‚", cause:["ç¼ºæ°§æœ«æœŸ"], rx:["CPR", "Epi", "ä¸å¯é›»æ“Š"], n:["ç¢ºèªå°ç¨‹", "å£“èƒ¸"], vis:'asystole' }
    };

    // --- Variables ---
    let curKey = 'nsr';
    let joules = 200, isCharging=false, isReady=false, shockFx=0, adenosineFx=0;
    let nibpTimer, isNibp=false;
    
    // --- Theme Logic ---
    function toggleTheme() {
        const body = document.body;
        if (body.getAttribute('data-theme') === 'light') body.removeAttribute('data-theme');
        else body.setAttribute('data-theme', 'light');
    }

    // --- Modal Logic ---
    function openModal() { document.getElementById('info-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('info-modal').style.display = 'none'; }

    // --- Logout Logic ---
    function logout() {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ")) {
            localStorage.removeItem('ecg_username');
            window.location.replace('login.html');
        }
    }

    // --- Canvas & Waveforms ---
    const canvas = document.getElementById('ecgCanvas'); const ctx = canvas.getContext('2d');
    let x=0; const speed=1.5; let lastY=150;
    window.addEventListener('resize', ()=>{canvas.width=canvas.parentElement.clientWidth; canvas.height=canvas.parentElement.clientHeight;});
    canvas.width=canvas.parentElement.clientWidth; canvas.height=canvas.parentElement.clientHeight;

    function getY(t) {
        let y = canvas.height/2;
        if(shockFx>0){shockFx--; return y+(Math.random()-0.5)*600;}
        if(adenosineFx>0){adenosineFx--; return y+(Math.random()-0.5)*2;}
        y+=(Math.random()-0.5)*2; const cyc=(d)=>t%d;

        if(['nsr','pea','sb','avb1'].includes(curKey)) {
            let dur=(curKey==='sb')?1300:800; let c=cyc(dur);
            if(c>50&&c<100)y-=5; if(c>150&&c<200){if(c<160)y+=5;else if(c<180)y-=50;else y+=10;} if(c>250&&c<350)y-=8*Math.sin((c-250)/100*Math.PI);
        }
        else if(curKey==='psvt'){let c=cyc(320); if(c>100&&c<150){if(c<110)y+=5;else if(c<130)y-=50;else y+=10;} if(c>180&&c<250)y-=8*Math.sin((c-180)/70*Math.PI);}
        else if(curKey==='afib'){y+=Math.sin(t*0.05)*3; if(cyc(600+Math.random()*200)<40)y-=40;}
        else if(curKey==='afl'){y-=Math.abs((t%200)-100)/5; if(t%400<40)y-=40;}
        else if(curKey==='pvc'){let c=cyc(800); if(c>50&&c<100)y-=5; if(c>150&&c<200){if(c<160)y+=5;else if(c<180)y-=50;else y+=10;} if(c>250&&c<350)y-=8; if(cyc(3200)<200)y+=Math.sin(t*0.02)*60;}
        else if(curKey.includes('vt')){let c=cyc(330); y+=Math.sin(c/330*Math.PI*2)*60;}
        else if(curKey==='vf'){y+=Math.sin(t*0.01)*20+Math.sin(t*0.03)*10;}
        else if(curKey==='tdp'){y+=Math.sin(t*0.03)*(Math.sin(t*0.002)*50+20);}
        else if(curKey.includes('avb3')){let p=t%600; let q=t%1500; if(p<50)y-=5; if(q<60)y-=50; else if(q>100&&q<250)y-=10*Math.sin((q-100)/150*Math.PI);}
        else if(curKey.includes('avb2')){let c=cyc(900); if(c>20&&c<70)y-=5; if(cyc(1800)<900){if(c>250&&c<300){if(c<260)y+=5;else if(c<280)y-=50;else y+=10;} if(c>350&&c<450)y-=8*Math.sin((c-350)/100*Math.PI);}}
        return y;
    }

    function draw(){ ctx.clearRect(x,0,6,canvas.height); ctx.beginPath(); ctx.strokeStyle='#4ade80'; ctx.lineWidth=2; let y=getY(Date.now()); ctx.moveTo(x-speed,lastY); ctx.lineTo(x,y); ctx.stroke(); lastY=y; x+=speed; if(x>=canvas.width){x=0;ctx.beginPath();} requestAnimationFrame(draw); }

    // --- Interaction ---
    function loadCase(k) {
        curKey = k; resetDefib();
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');

        const d = DB[k];
        updateVitals(d);
        document.getElementById('txt-title').innerText = d.t;
        document.getElementById('txt-tag').innerText = d.b;
        document.getElementById('txt-tag').style.background = d.c;

        fill('list-criteria', d.cri);
        fill('list-rx', d.rx);
        fill('list-nurse', d.n);
        fill('list-causes', d.cause);
        document.getElementById('txt-patho').innerText = d.patho;

        // Alert Logic
        const alert = document.getElementById('alert-box');
        if (d.shock) {
            alert.style.display = 'block';
            alert.style.backgroundColor = '#FFF9C4'; 
            alert.style.color = 'black';
            alert.style.border = '5px solid #FF9800';
            alert.innerHTML = "âš¡ <strong>ã€æ³¨æ„ã€‘è¦–æƒ…å½¢é›»æ“Šï¼</strong> åœ¨é†«å¸«æˆ–å°ˆç§‘è­·ç†å¸«ç›£ç£ä¸‹å¯åŸ·è¡Œé›»æ“Šå»é¡«ï¼âš¡";
        } 
        else if (k === 'pea' || k === 'asystole') {
            alert.style.display = 'block';
            alert.style.backgroundColor = '#FF5252'; 
            alert.style.color = 'white';
            alert.style.border = '5px solid #D32F2F';
            alert.innerHTML = "â›” <strong>ã€é‡è¦ã€‘è«‹ä¸è¦é›»æ“Šï¼</strong>çµ¦äºˆCPRå³å¯ï¼â›”";
        } 
        else {
            alert.style.display = 'none';
            alert.style.border = 'none';
        }
        updateAnatomy(d.vis);
    }

    function updateVitals(d) {
        document.getElementById('val-hr').innerText=d.hr; document.getElementById('val-spo2').innerText=d.spo2;
        document.getElementById('val-rr').innerText=d.rr; document.getElementById('val-temp').innerText=d.temp;
        if(d.sys!=="---"){document.getElementById('val-sys').innerText=d.sys; document.getElementById('val-dia').innerText=d.dia;}
        else{document.getElementById('val-sys').innerText="---"; document.getElementById('val-dia').innerText="---";}
    }

    function updateAnatomy(vis) {
        const m = document.getElementById('heart-muscle'); m.classList.remove('mech-fail');
        const sa=document.getElementById('node-sa'); const av=document.getElementById('node-av');
        document.querySelectorAll('.node, .path-conduction').forEach(e=>e.style.animation='none');
        ['vis-block','vis-psvt','vis-tdp'].forEach(id=>document.getElementById(id).style.display='none');
        document.getElementById('anatomy-text').innerText="";
        
        if(vis==='nsr'||vis==='pea'){ sa.style.animation=av.style.animation='flash 0.8s infinite'; if(vis==='pea') m.classList.add('mech-fail'); }
        else if(vis==='psvt'||vis==='afl'){ document.getElementById('vis-psvt').style.display='block'; document.getElementById('vis-psvt').classList.add('reentry'); }
        else if(vis==='tdp'){ document.getElementById('vis-tdp').style.display='block'; }
        else if(vis.includes('block')){ document.getElementById('vis-block').style.display='block'; sa.style.animation='flash 0.8s infinite'; }
    }

    // --- Meds & Defib ---
    function giveDrug(d){
        const l=document.getElementById('med-log'); const i=document.createElement('div'); i.className='log-item';
        i.innerText=`ğŸ’‰ ${d}`; if(d.includes('Aden') && curKey==='psvt') setTimeout(()=>{adenosineFx=150; setTimeout(()=>loadCase('nsr'),2500);},1000);
        l.appendChild(i); setTimeout(()=>i.remove(),5000);
    }
    function adjJ(v){ joules=Math.max(50,Math.min(360,joules+v)); document.getElementById('joule-val').innerText=joules; }
    function charge(){ if(isCharging||isReady)return; isCharging=true; document.getElementById('btn-charge').innerText="Charging..."; setTimeout(()=>{isCharging=false;isReady=true;document.getElementById('btn-charge').innerText="Charged";document.getElementById('btn-shock').disabled=false;document.getElementById('btn-shock').classList.add('ready');},2000); }
    function shock(){ if(!isReady)return; shockFx=20; document.getElementById('screen-flash').classList.add('flash-anim'); setTimeout(()=>document.getElementById('screen-flash').classList.remove('flash-anim'),200); 
        if(DB[curKey].shock) setTimeout(()=>loadCase('nsr'),1000); else if(['nsr','psvt','afib'].includes(curKey)) setTimeout(()=>loadCase('vf'),1000);
        resetDefib(); }
    function resetDefib(){ isReady=false;isCharging=false;document.getElementById('btn-charge').innerText="Charge";const s=document.getElementById('btn-shock');s.disabled=true;s.classList.remove('ready');}
    function toggleNIBP(){
        const b=document.getElementById('btn-nibp'); if(b.innerText.includes("Stop")){clearInterval(nibpTimer);b.innerText="Start";b.classList.remove('active');return;}
        b.innerText="Stop"; b.classList.add('active'); document.getElementById('val-sys').innerText="---"; document.getElementById('val-dia').innerText="---";
        setTimeout(()=>{ b.innerText="Start"; b.classList.remove('active'); const d=DB[curKey]; if(d.sys!=="---"){const r=Math.floor(Math.random()*6)-3;document.getElementById('val-sys').innerText=d.sys+r;document.getElementById('val-dia').innerText=d.dia+r;}},3000);
    }

    // --- Utils ---
    function fill(id,arr){document.getElementById(id).innerHTML=arr?arr.map(i=>`<li>${i}</li>`).join(''):'';}
    function setTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById(`tab-${id}`).classList.add('active');document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');}

    // Init
    draw(); loadCase('nsr');
    setInterval(()=>{if(DB[curKey].hr!=="---"){document.getElementById('val-hr').innerText=DB[curKey].hr+Math.floor(Math.random()*3)-1;}},2000);

    // --- Logic: Read User from LocalStorage ---
    // ç¢ºä¿é é¢å…ƒç´ éƒ½è¼‰å…¥å¾Œæ‰åŸ·è¡Œï¼Œä¸¦æ­£ç¢ºé¡¯ç¤ºåå­—
    window.addEventListener('DOMContentLoaded', () => {
        const badge = document.getElementById('user-staff-badge');
        const storedName = localStorage.getItem('ecg_username');
        
        if (badge) {
            if (storedName && storedName.trim() !== "") {
                badge.innerHTML = `é†«è­·äººå“¡ï¼š<strong>${storedName}</strong>`;
            } else {
                badge.innerHTML = `é†«è­·äººå“¡ï¼š<strong>è¨ªå®¢</strong>`;
            }
        } else {
            console.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° id='user-staff-badge' çš„é¡¯ç¤ºå€åŸŸï¼è«‹æª¢æŸ¥ HTMLã€‚");
        }
    });
</script>
</body>
</html>
